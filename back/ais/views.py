import openai
import re
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from django.conf import settings

# 1. GMS í´ë¼ì´ì–¸íŠ¸
client = openai.OpenAI(
    api_key=settings.GMS_API_KEY,
    base_url="https://gms.ssafy.io/gmsapi/api.openai.com/v1" 
)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def diagnosis(request):
    """
    GPT-4oë¥¼ ì‚¬ìš©í•˜ì—¬ ìì‚° ì§„ë‹¨ ë¦¬í¬íŠ¸ ìƒì„±
    """
    try:
        # Vueì—ì„œ ë³´ë‚¸ ë°ì´í„° ì¶”ì¶œ
        data = request.data
        total_assets = data.get('totalAssets', 0)
        total_cash = data.get('totalCash', 0)
        total_invest = data.get('totalInvest', 0)
        total_debt = data.get('totalDebt', 0)
        net_worth = data.get('netWorth', 0)
        income = data.get('income', 0)
        expense = data.get('expense', 0)
        sections = data.get('sections', [])

        # ë¹„ìœ¨ ê³„ì‚°
        cash_ratio = (total_cash / total_assets * 100) if total_assets > 0 else 0
        invest_ratio = (total_invest / total_assets * 100) if total_assets > 0 else 0

        # GPT ì „ë‹¬ìš© í”„ë¡¬í”„íŠ¸ ì¡°ë¦½
        prompt_content = f"""
ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ì „ë¬¸ ê¸ˆìœµ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ê³ ê°ì˜ ìì‚° í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•˜ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.

## ğŸ“Š ê³ ê° ìì‚° í˜„í™©
- **ì›” ì†Œë“/ì§€ì¶œ**: {income:,.0f}ì› / {expense:,.0f}ì›
- **ì´ ìì‚°**: {total_assets:,.0f}ì› (í˜„ê¸ˆ {cash_ratio:.1f}%, íˆ¬ì {invest_ratio:.1f}%)
- **ë¶€ì±„/ìˆœìì‚°**: {total_debt:,.0f}ì› / {net_worth:,.0f}ì›

### ìƒì„¸ ìì‚° ë‚´ì—­
"""
        for sec in sections:
            prompt_content += f"\n[{sec['label']}] (í•©ê³„: {sec['total']:,.0f}ì›)\n"
            for group in sec.get('groups', []):
                prompt_content += f"- {group['categoryName']}: {group['totalValue']:,.0f}ì›\n"
                for item in group.get('items', []):
                    prompt_content += f"  â”” {item['name']}: {float(item.get('current_value', 0)):,.0f}ì›\n"

        prompt_content += """
## ğŸ“‹ ë¶„ì„ ìš”ì²­ì‚¬í•­
ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ **í•œêµ­ì–´**ë¡œ ìƒì„¸í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”:
# ğŸ’° ìì‚° ì§„ë‹¨ ë¦¬í¬íŠ¸

## ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„
(ì´ ì„¹ì…˜ ì•ˆì— ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ í•˜ë‚˜ì˜ ê¸€ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”)
1. ìì‚° êµ¬ì„±: ì´ ìì‚° ëŒ€ë¹„ í˜„ê¸ˆ ë° íˆ¬ì ìì‚°ì˜ ë¹„ìœ¨ê³¼ ê·¸ì— ëŒ€í•œ ì§„ë‹¨
2. ë¶€ì±„ ìƒí™©: ì´ ë¶€ì±„ì™€ ìˆœìì‚° í˜„í™© ë° ë¶€ì±„ ê´€ë¦¬ ì „ëµ

## ğŸ’ª ê°•ì 
## âš ï¸ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„
## ğŸ’¡ ë§ì¶¤ ì‹¤í–‰ ì œì•ˆ
## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

**ì‘ì„± ê°€ì´ë“œ:**
- **ì¤‘ìš”**: 'ìì‚° êµ¬ì„±'ì´ë‚˜ 'ë¶€ì±„ ìƒí™©'ì„ ë³„ë„ì˜ '## ì œëª©'ìœ¼ë¡œ ë§Œë“¤ì§€ ë§ˆì„¸ìš”.
- ì˜¤ì§ '## ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„'ì´ë¼ëŠ” ì œëª© ì•„ë˜ì— ëª¨ë“  ë‚´ìš©ì„ ì„œìˆ í˜•ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
- ì¹œê·¼í•˜ê³  ê³µê°í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ì„±
- êµ¬ì²´ì ì¸ ìˆ«ìì™€ ë¹„ìœ¨ ì–¸ê¸‰
- ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
- ê°€ë…ì„±ì´ ì¢‹ê²Œ ì´ëª¨í‹°ì½˜ í™œìš©
"""

        # GPT API í˜¸ì¶œ
        response = client.chat.completions.create(
            model="gpt-4o", 
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ê³ ê°ì˜ ìì‚°ì„ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ê¸ˆìœµ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ëŠ” AI ë¹„ì„œ 'ë¨¸ë‹ˆë¹ˆ'ì…ë‹ˆë‹¤."},
                {"role": "user", "content": prompt_content}
            ],
            temperature=0.7
        )

        full_report = response.choices[0].message.content
        
        # ì„¹ì…˜ë³„ë¡œ íŒŒì‹±
        parsed_sections = parse_report_sections(full_report)
        
        # ê²°ê³¼ ë°˜í™˜ (sectionsë§Œ)
        return Response({
            'success': True,
            'sections': parsed_sections
        })

    except Exception as e:
        return Response({
            'success': False,
            'error': f'GPT ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'
        }, status=500)


def parse_report_sections(report_text):
    """
    ë¦¬í¬íŠ¸ë¥¼ ì„¹ì…˜ë³„ë¡œ íŒŒì‹± (# ì œëª©ê³¼ ## ì œëª© ëª¨ë‘ í¬í•¨)
    """
    sections = []
    
    # # ì œëª© ì°¾ê¸° (ìì‚° ì§„ë‹¨ ë¦¬í¬íŠ¸)
    main_title_pattern = r'^#\s+(.+?)$'
    main_title_match = re.search(main_title_pattern, report_text, re.MULTILINE)
    
    # # ì œëª© ì´í›„ë¶€í„° ì²« ë²ˆì§¸ ## ì œëª© ì „ê¹Œì§€ì˜ ë‚´ìš© (ìˆë‹¤ë©´)
    main_content = ''
    if main_title_match:
        main_title_end = main_title_match.end()
        first_section_match = re.search(r'##', report_text[main_title_end:])
        if first_section_match:
            main_content = report_text[main_title_end:main_title_end + first_section_match.start()].strip()
        else:
            main_content = report_text[main_title_end:].strip()
        
        sections.append({
            'title': main_title_match.group(1).strip(),
            'content': main_content,
            'is_main': True
        })
    
    # ## ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í•˜ìœ„ ì œëª©ë“¤
    pattern = r'##\s+(.+?)(?=##|$)'
    matches = re.finditer(pattern, report_text, re.DOTALL)
    
    for match in matches:
        full_text = match.group(0).strip()
        
        # ì œëª©ê³¼ ë‚´ìš© ë¶„ë¦¬
        lines = full_text.split('\n', 1)
        title = lines[0].replace('##', '').strip()
        content = lines[1].strip() if len(lines) > 1 else ''
        
        sections.append({
            'title': title,
            'content': content,
            'is_main': False
        })
    
    return sections
    
@api_view(['POST'])
@permission_classes([IsAuthenticated])
def recommend_products(request):
    """
    ========================================
    ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ ê¸ˆìœµìƒí’ˆ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜
    ========================================

    ** ì•Œê³ ë¦¬ì¦˜ ì „ì²´ íë¦„ë„ **

    [ì‚¬ìš©ì ì…ë ¥]
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 1-2: ì¬ì • ë°ì´í„° ìˆ˜ì§‘ ë° í•µì‹¬ ì§€í‘œ ê³„ì‚°            â”‚
    â”‚  - í˜„ê¸ˆ ë¹„ìœ¨, íˆ¬ì ë¹„ìœ¨, ë¶€ì±„ ë¹„ìœ¨, ì €ì¶•ë¥  ì‚°ì¶œ        â”‚
    â”‚  - ê¸°ì¤€ì¹˜ ëŒ€ë¹„ ìœ„í—˜ë„ í‰ê°€ (ì˜ˆ: ë¶€ì±„ 30% ì´ìƒ â†’ ì£¼ì˜)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 3: ì‚¬ìš©ì í”„ë¡œí•„ ë¶„ì„ (ì—°ë ¹ëŒ€ë³„ ì „ëµ)              â”‚
    â”‚  - 20-30ëŒ€: ê³µê²©ì  íˆ¬ì ê°€ëŠ¥ (ì£¼ì‹ ë¹„ì¤‘ â†‘)             â”‚
    â”‚  - 40-50ëŒ€: ì•ˆì •ì„± ì¤‘ì‹œ (ì˜ˆê¸ˆ ë¹„ì¤‘ â†‘)                  â”‚
    â”‚  - 60ëŒ€+: ë³´ìˆ˜ì  ìš´ìš© (í˜„ê¸ˆ ìœ„ì£¼)                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 4-5: ìƒí’ˆ í’€ êµ¬ì„± ë° íŠ¹ì§• ì¶”ì¶œ                     â”‚
    â”‚  - DBì—ì„œ ì˜ˆì ê¸ˆ ìƒí’ˆ ì¡°íšŒ (ê¸ˆìœµê°ë…ì› API ë°ì´í„°)     â”‚
    â”‚  - ê° ìƒí’ˆì˜ ìµœê³  ìš°ëŒ€ê¸ˆë¦¬, ê°€ì…ë°©ë²• ë“± ì •ê·œí™”         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 6-7: AI í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ & GPT-4o ì¶”ë¡          â”‚
    â”‚  - êµ¬ì¡°í™”ëœ í”„ë¡¬í”„íŠ¸ ì„¤ê³„ (ì—­í• /ì»¨í…ìŠ¤íŠ¸/ì œì•½ì¡°ê±´)     â”‚
    â”‚  - í¬íŠ¸í´ë¦¬ì˜¤ ê· í˜• íšŒë³µ ë¡œì§ ëª…ì‹œ                       â”‚
    â”‚  - JSON ì‘ë‹µ ê°•ì œ (íŒŒì‹± ì•ˆì •ì„±)                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 8-9: ê²°ê³¼ íŒŒì‹± ë° í”„ë¡ íŠ¸ì—”ë“œ ì „ë‹¬                  â”‚
    â”‚  - portfolio_analysis: 4ëŒ€ ì§€í‘œë³„ í‰ê°€                 â”‚
    â”‚  - recommended_products: ìµœëŒ€ 3ê°œ ìƒí’ˆ (ìš°ì„ ìˆœìœ„ë³„)    â”‚
    â”‚  - investment_strategy: ì¢…í•© ì „ëµ                      â”‚
    â”‚  - action_items: êµ¬ì²´ì  ì‹¤í–‰ í•­ëª©                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    [Vue ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‹œê°í™”]


    ** ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ í•µì‹¬ ë…¼ë¦¬ (ë°œí‘œìš©) **

    1ï¸âƒ£ ë‹¤ì°¨ì› ì¬ì • ê±´ê°•ë„ í‰ê°€ (Multi-Dimensional Assessment)
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ í˜„ê¸ˆ ë¹„ìœ¨   = (í˜„ê¸ˆ ìì‚° / ì´ ìì‚°) Ã— 100        â”‚
       â”‚ íˆ¬ì ë¹„ìœ¨   = (íˆ¬ì ìì‚° / ì´ ìì‚°) Ã— 100        â”‚
       â”‚ ë¶€ì±„ ë¹„ìœ¨   = (ì´ ë¶€ì±„ / ì´ ìì‚°) Ã— 100          â”‚
       â”‚ ì €ì¶•ë¥       = (ì›” ì‰ì—¬ê¸ˆ / ì›” ì†Œë“) Ã— 100        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       ê° ì§€í‘œë¥¼ ê¸°ì¤€ì¹˜ì™€ ë¹„êµí•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¶ˆê· í˜• ì§„ë‹¨
       ì˜ˆ) í˜„ê¸ˆ ë¹„ìœ¨ > 40% â†’ ê¸°íšŒë¹„ìš© ë°œìƒ (ì ê¸ˆ ì¶”ì²œ ì‹ í˜¸)
           ë¶€ì±„ ë¹„ìœ¨ > 30% â†’ ì¬ì • ìœ„í—˜ (ìƒí™˜ ì¤€ë¹„ê¸ˆ ë§ˆë ¨ í•„ìš”)

    2ï¸âƒ£ í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™” ê¸°ë°˜ ìƒí’ˆ ë§¤ì¹­ ê·œì¹™
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœ      â”‚ ì¶”ì²œ ì „ëµ                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ í˜„ê¸ˆ ê³¼ë‹¤ ë³´ìœ        â”‚ ì ê¸ˆ â†’ ì €ì¶• ìŠµê´€ í˜•ì„±     â”‚
       â”‚ íˆ¬ì ë¹„ì¤‘ ê³¼ë‹¤       â”‚ ì˜ˆê¸ˆ â†’ ì•ˆì •ì„± í™•ë³´        â”‚
       â”‚ ë¶€ì±„ ë¹„ìœ¨ ë†’ìŒ       â”‚ ë‹¨ê¸° ì˜ˆê¸ˆ â†’ ìœ ë™ì„± í™•ë³´   â”‚
       â”‚ ì›” ì‰ì—¬ê¸ˆ ì¶©ë¶„       â”‚ ì¥ê¸° ì ê¸ˆ â†’ ë³µë¦¬ ê·¹ëŒ€í™”   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    3ï¸âƒ£ ìš°ì„ ìˆœìœ„ ê²°ì • ì•Œê³ ë¦¬ì¦˜ (3ë‹¨ê³„ Priority Scoring)
       â€¢ Priority 1 (ìµœìš°ì„ ): í¬íŠ¸í´ë¦¬ì˜¤ ê· í˜• íšŒë³µì´ ê°€ì¥ ì‹œê¸‰í•œ ìƒí’ˆ
         â†’ í˜„ê¸ˆ/íˆ¬ì/ë¶€ì±„ ë¹„ìœ¨ ì¤‘ ê°€ì¥ ë¬¸ì œê°€ ë˜ëŠ” ì§€í‘œ ê°œì„ ìš©

       â€¢ Priority 2 (ì¶”ì²œ): ìˆ˜ìµë¥  ìµœì í™”ë¥¼ ìœ„í•œ ë³´ì¡° ìƒí’ˆ
         â†’ ìµœê³  ê¸ˆë¦¬ + ë¹„ëŒ€ë©´ ê°€ì… í¸ì˜ì„± ê³ ë ¤

       â€¢ Priority 3 (ê³ ë ¤): ì¥ê¸° ì¬ë¬´ ëª©í‘œ ë‹¬ì„±ìš© ì¶”ê°€ ìƒí’ˆ
         â†’ ì¥ê¸° ì ê¸ˆ, ëª©ëˆ ë§ˆë ¨ ë“±

    4ï¸âƒ£ AI ê¸°ë°˜ ê°œì¸í™” (GPT-4oë¥¼ í™œìš©í•œ ë§¥ë½ ì´í•´)
       ì „í†µì  ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œì˜ í•œê³„:
       - ë‹¨ìˆœ if-else ë¡œì§ìœ¼ë¡œëŠ” ë³µì¡í•œ ì¬ì • ìƒí™© ì²˜ë¦¬ ë¶ˆê°€
       - ê°œì¸ë³„ íŠ¹ìˆ˜ ìƒí™© (ì˜ˆ: ê²°í˜¼ ì¤€ë¹„, ì§‘ ë§ˆë ¨) ê³ ë ¤ ì–´ë ¤ì›€

       GPT-4o í™œìš©ì˜ ì¥ì :
       âœ“ 4ê°€ì§€ í•µì‹¬ ì§€í‘œë¥¼ ì¢…í•©ì ìœ¼ë¡œ í•´ì„
       âœ“ ì—°ë ¹, ì†Œë“, ë¶€ì±„ ë“± ë‹¤ì°¨ì› ë³€ìˆ˜ ë™ì‹œ ê³ ë ¤
       âœ“ ìì—°ì–´ë¡œ ì¶”ì²œ ê·¼ê±° ì„¤ëª… â†’ ì‹ ë¢°ì„± â†‘
       âœ“ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •ë§Œìœ¼ë¡œ ì¶”ì²œ ì „ëµ ìœ ì—°í•˜ê²Œ ë³€ê²½ ê°€ëŠ¥
    """
    try:
        user = request.user
        data = request.data

        # ===== STEP 1: ì‚¬ìš©ì ì¬ì • ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬ =====
        # í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì „ë‹¬ë°›ì€ ìì‚°/ë¶€ì±„/ì†Œë“/ì§€ì¶œ ë°ì´í„° ì¶”ì¶œ
        total_assets = data.get('totalAssets', 0)      # ì´ ìì‚° (í˜„ê¸ˆ + íˆ¬ì)
        total_cash = data.get('totalCash', 0)          # í˜„ê¸ˆì„± ìì‚°
        total_invest = data.get('totalInvest', 0)      # íˆ¬ì ìì‚°
        total_debt = data.get('totalDebt', 0)          # ì´ ë¶€ì±„
        net_worth = data.get('netWorth', 0)            # ìˆœìì‚° (ìì‚° - ë¶€ì±„)
        income = data.get('income', 0)                 # ì›” ì†Œë“
        expense = data.get('expense', 0)               # ì›” ì§€ì¶œ
        monthly_surplus = income - expense             # ì›” ì‰ì—¬ê¸ˆ (ì €ì¶• ê°€ëŠ¥ ê¸ˆì•¡)

        # ===== STEP 2: í•µì‹¬ ì¬ì • ì§€í‘œ ê³„ì‚° =====
        # ì´ ì§€í‘œë“¤ì€ GPTì—ê²Œ ì „ë‹¬ë˜ì–´ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ì˜ ê¸°ì´ˆ ë°ì´í„°ë¡œ í™œìš©ë¨

        # 2-1. í˜„ê¸ˆ ë¹„ìœ¨ = (í˜„ê¸ˆì„± ìì‚° / ì´ ìì‚°) Ã— 100
        # â†’ ì¼ë°˜ì ìœ¼ë¡œ 20-30%ê°€ ì ì •, ë„ˆë¬´ ë†’ìœ¼ë©´ ê¸°íšŒë¹„ìš© ì†ì‹¤, ë‚®ìœ¼ë©´ ìœ ë™ì„± ìœ„í—˜
        cash_ratio = (total_cash / total_assets * 100) if total_assets > 0 else 0

        # 2-2. íˆ¬ì ë¹„ìœ¨ = (íˆ¬ì ìì‚° / ì´ ìì‚°) Ã— 100
        # â†’ ì—°ë ¹ê³¼ ìœ„í—˜ ì„±í–¥ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ë³´í†µ 70-80% ì´í•˜ ê¶Œì¥
        invest_ratio = (total_invest / total_assets * 100) if total_assets > 0 else 0

        # 2-3. ë¶€ì±„ ë¹„ìœ¨ = (ì´ ë¶€ì±„ / ì´ ìì‚°) Ã— 100
        # â†’ 50% ì´ìƒì´ë©´ ìœ„í—˜ êµ¬ê°„, 30% ì´í•˜ê°€ ì•ˆì •ì 
        debt_ratio = (total_debt / total_assets * 100) if total_assets > 0 else 0

        # 2-4. ì›” ì—¬ìœ ê¸ˆ ë¹„ìœ¨ = (ì›” ì‰ì—¬ê¸ˆ / ì›” ì†Œë“) Ã— 100
        # â†’ 20% ì´ìƒì´ë©´ ê±´ê°•í•œ ì €ì¶•ë¥ 
        surplus_ratio = (monthly_surplus / income * 100) if income > 0 else 0

        # ===== STEP 3: ì‚¬ìš©ì í”„ë¡œí•„ ë¶„ì„ (ì—°ë ¹ëŒ€ë³„ í¬íŠ¸í´ë¦¬ì˜¤ ì „ëµ) =====
        age = None
        if hasattr(user, 'birth_date') and user.birth_date:
            from datetime import datetime
            today = datetime.now()
            age = today.year - user.birth_date.year
            # ì—°ë ¹ëŒ€ë³„ ê¶Œì¥ ì „ëµ:
            # - 20-30ëŒ€: ê³µê²©ì  íˆ¬ì ê°€ëŠ¥ (ì£¼ì‹/í€ë“œ ë¹„ì¤‘ ë†’ì„)
            # - 40-50ëŒ€: ì•ˆì •ì„± ì¤‘ì‹œ (ì˜ˆê¸ˆ/ì ê¸ˆ ë¹„ì¤‘ ì¦ê°€)
            # - 60ëŒ€ ì´ìƒ: ë³´ìˆ˜ì  ìš´ìš© (í˜„ê¸ˆ/ì˜ˆê¸ˆ ìœ„ì£¼)

        # ===== STEP 4: ì¶”ì²œ ëŒ€ìƒ ìƒí’ˆ í’€ êµ¬ì„± =====
        # DBì—ì„œ ê¸ˆìœµê°ë…ì› APIë¡œ ìˆ˜ì§‘í•œ ì‹¤ì œ ì˜ˆì ê¸ˆ ìƒí’ˆ ì¡°íšŒ
        from deposits.models import DepositProducts, SavingProducts

        # prefetch_related: N+1 ì¿¼ë¦¬ ë¬¸ì œ ë°©ì§€ (options í…Œì´ë¸” ì¡°ì¸ ìµœì í™”)
        deposits = DepositProducts.objects.prefetch_related('options').all()
        savings = SavingProducts.objects.prefetch_related('options').all()

        # ===== STEP 5: ìƒí’ˆ ë°ì´í„° ì •ê·œí™” ë° íŠ¹ì§• ì¶”ì¶œ =====
        # ê° ìƒí’ˆì˜ ìµœê³  ìš°ëŒ€ê¸ˆë¦¬ë¥¼ ê³„ì‚°í•˜ì—¬ ë¹„êµ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜
        # (ìƒìœ„ 20ê°œë§Œ ì„ íƒí•˜ì—¬ GPT í† í° ì‚¬ìš©ëŸ‰ ìµœì í™”)

        deposit_info = []
        for dep in deposits[:20]:
            # í•´ë‹¹ ìƒí’ˆì˜ ëª¨ë“  ì˜µì…˜ ì¤‘ ìµœê³  ìš°ëŒ€ê¸ˆë¦¬ ì¶”ì¶œ
            max_rate = max([opt.intr_rate2 for opt in dep.options.all()], default=0)
            deposit_info.append({
                'code': dep.fin_prdt_cd,           # ìƒí’ˆ ê³ ìœ  ì½”ë“œ
                'bank': dep.kor_co_nm,             # ì€í–‰ëª…
                'name': dep.fin_prdt_nm,           # ìƒí’ˆëª…
                'max_rate': max_rate,              # ìµœê³  ìš°ëŒ€ê¸ˆë¦¬ (ì¶”ì²œ ì‹œ ì£¼ìš” ì§€í‘œ)
                'join_way': dep.join_way or ''     # ê°€ì… ë°©ë²• (ë¹„ëŒ€ë©´ ì—¬ë¶€ íŒë‹¨)
            })

        saving_info = []
        for sav in savings[:20]:
            max_rate = max([opt.intr_rate2 for opt in sav.options.all()], default=0)
            saving_info.append({
                'code': sav.fin_prdt_cd,
                'bank': sav.kor_co_nm,
                'name': sav.fin_prdt_nm,
                'max_rate': max_rate,
                'join_way': sav.join_way or ''
            })

        # ===== STEP 6: AI í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ (Prompt Engineering) =====
        # GPT-4oì—ê²Œ ì „ë‹¬í•  êµ¬ì¡°í™”ëœ í”„ë¡¬í”„íŠ¸ ì‘ì„±
        # í”„ë¡¬í”„íŠ¸ ì„¤ê³„ ì›ì¹™:
        # 1) ì—­í•  ë¶€ì—¬ (Role Assignment): "ê¸ˆìœµ ìì‚°ê´€ë¦¬ ì „ë¬¸ê°€"ë¡œ í˜ë¥´ì†Œë‚˜ ì„¤ì •
        # 2) ì»¨í…ìŠ¤íŠ¸ ì œê³µ (Context): ì‚¬ìš©ìì˜ ìƒì„¸í•œ ì¬ì • ë°ì´í„° ì „ë‹¬
        # 3) ì‘ì—… ì •ì˜ (Task): í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ + ìƒí’ˆ ì¶”ì²œ ëª…í™•í™”
        # 4) ì¶œë ¥ í˜•ì‹ ì§€ì • (Format): JSON ìŠ¤í‚¤ë§ˆë¡œ êµ¬ì¡°í™”ëœ ì‘ë‹µ ìœ ë„
        # 5) ì œì•½ ì¡°ê±´ ëª…ì‹œ (Constraints): ì¶”ì²œ ê¸°ì¤€ ë° ê°œìˆ˜ ì œí•œ

        prompt_content = f"""
ë‹¹ì‹ ì€ ê¸ˆìœµ ìì‚°ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê³ ê°ì˜ ì¬ì • ìƒíƒœë¥¼ ë¶„ì„í•˜ê³  í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ìœ¼ë¡œ ìµœì ì˜ ê¸ˆìœµ ìƒí’ˆì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.

## ê³ ê° ì¬ì • í˜„í™©
- ë‚˜ì´: {age if age else 'ë¯¸ì œê³µ'}ì„¸
- ì›” ì†Œë“/ì§€ì¶œ: {income:,.0f}ì› / {expense:,.0f}ì› (ì›” ì‰ì—¬ê¸ˆ: {monthly_surplus:,.0f}ì›)
- ì €ì¶•ë¥ : {surplus_ratio:.1f}% (ì›” ì‰ì—¬ê¸ˆ / ì›” ì†Œë“)

- ì´ ìì‚°: {total_assets:,.0f}ì›
  - í˜„ê¸ˆì„± ìì‚°: {total_cash:,.0f}ì› ({cash_ratio:.1f}%)
  - íˆ¬ì ìì‚°: {total_invest:,.0f}ì› ({invest_ratio:.1f}%)

- ì´ ë¶€ì±„: {total_debt:,.0f}ì› ({debt_ratio:.1f}%)
- ìˆœìì‚°: {net_worth:,.0f}ì›

## ì¬ì • ê±´ê°•ë„ í•µì‹¬ ì§€í‘œ ë¶„ì„ ê°€ì´ë“œ
1. í˜„ê¸ˆ ë¹„ìœ¨ ({cash_ratio:.1f}%):
   - ì ì • ë²”ìœ„ 20-30% / ê³¼ë‹¤ ë³´ìœ  ì‹œ ê¸°íšŒë¹„ìš© ë°œìƒ â†’ ì ê¸ˆ ì¶”ì²œ
   - ë¶€ì¡± ì‹œ ìœ ë™ì„± ìœ„í—˜ â†’ ë‹¨ê¸° ì˜ˆê¸ˆ ì¶”ì²œ

2. íˆ¬ì ë¹„ìœ¨ ({invest_ratio:.1f}%):
   - ì—°ë ¹ë³„ ì ì • ë¹„ìœ¨: 20-30ëŒ€(70-80%), 40-50ëŒ€(50-60%), 60ëŒ€+(30-40%)
   - ê³¼ë‹¤ íˆ¬ì ì‹œ â†’ ì˜ˆê¸ˆìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´ í•„ìš”

3. ë¶€ì±„ ë¹„ìœ¨ ({debt_ratio:.1f}%):
   - ì•ˆì • êµ¬ê°„: 30% ì´í•˜ / ì£¼ì˜ êµ¬ê°„: 30-50% / ìœ„í—˜ êµ¬ê°„: 50% ì´ìƒ
   - ë¶€ì±„ ë¹„ìœ¨ ë†’ìœ¼ë©´ â†’ ê³ ê¸ˆë¦¬ ë‹¨ê¸° ì˜ˆê¸ˆìœ¼ë¡œ ìƒí™˜ ìê¸ˆ ë§ˆë ¨

4. ì €ì¶•ë¥  ({surplus_ratio:.1f}%):
   - ê±´ê°•í•œ ì €ì¶•ë¥ : 20% ì´ìƒ
   - ì €ì¶•ë¥  ë†’ìœ¼ë©´ â†’ ì¥ê¸° ì ê¸ˆìœ¼ë¡œ ë³µë¦¬ íš¨ê³¼ ê·¹ëŒ€í™”
   - ì €ì¶•ë¥  ë‚®ìœ¼ë©´ â†’ ì§€ì¶œ ê´€ë¦¬ ìš°ì„ , ì†Œì•¡ ì ê¸ˆìœ¼ë¡œ ìŠµê´€ í˜•ì„±

## ì¶”ì²œ ê°€ëŠ¥í•œ ì˜ˆê¸ˆ ìƒí’ˆ (ìƒìœ„ 20ê°œ)
{format_products_for_prompt(deposit_info)}

## ì¶”ì²œ ê°€ëŠ¥í•œ ì ê¸ˆ ìƒí’ˆ (ìƒìœ„ 20ê°œ)
{format_products_for_prompt(saving_info)}

## ë¶„ì„ ë° ì¶”ì²œ ìš”ì²­
ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{{
  "portfolio_analysis": {{
    "cash_ratio_assessment": "í˜„ê¸ˆ ë¹„ìœ¨ {cash_ratio:.1f}%ì— ëŒ€í•œ í‰ê°€ ë° ì¡°ì–¸ (2-3ë¬¸ì¥)",
    "investment_ratio_assessment": "íˆ¬ì ë¹„ìœ¨ {invest_ratio:.1f}%ì— ëŒ€í•œ í‰ê°€ ë° ì¡°ì–¸ (2-3ë¬¸ì¥)",
    "debt_assessment": "ë¶€ì±„ ë¹„ìœ¨ {debt_ratio:.1f}%ì— ëŒ€í•œ í‰ê°€ ë° ê´€ë¦¬ ì „ëµ (2-3ë¬¸ì¥)",
    "liquidity_assessment": "ì €ì¶•ë¥  {surplus_ratio:.1f}% ë° ì›” ì‰ì—¬ê¸ˆ {monthly_surplus:,.0f}ì›ì— ëŒ€í•œ í‰ê°€ (2-3ë¬¸ì¥)"
  }},
  "recommended_products": [
    {{
      "product_code": "ìƒí’ˆì½”ë“œ",
      "product_type": "deposit ë˜ëŠ” saving",
      "bank_name": "ì€í–‰ëª…",
      "product_name": "ìƒí’ˆëª…",
      "max_rate": ìµœê³ ê¸ˆë¦¬,
      "reason": "ì´ ìƒí’ˆì„ ì¶”ì²œí•˜ëŠ” êµ¬ì²´ì ì¸ ì´ìœ  (í¬íŠ¸í´ë¦¬ì˜¤ ê´€ì ì—ì„œ 3-4ë¬¸ì¥)",
      "priority": 1
    }}
  ],
  "investment_strategy": "ìœ„ í•µì‹¬ ì§€í‘œë¥¼ ì¢…í•©í•˜ì—¬ ê³ ê°ì—ê²Œ ë§ëŠ” ì „ë°˜ì ì¸ íˆ¬ì ì „ëµ ì œì•ˆ (4-5ë¬¸ì¥)",
  "action_items": [
    "êµ¬ì²´ì ì¸ ì‹¤í–‰ í•­ëª© 1 (ì˜ˆ: ì›” 50ë§Œì› ì ê¸ˆ ê°€ì…)",
    "êµ¬ì²´ì ì¸ ì‹¤í–‰ í•­ëª© 2 (ì˜ˆ: ë¹„ìƒê¸ˆ 300ë§Œì› ë‹¨ê¸° ì˜ˆê¸ˆ ì˜ˆì¹˜)",
    "êµ¬ì²´ì ì¸ ì‹¤í–‰ í•­ëª© 3 (ì˜ˆ: ê³ ê¸ˆë¦¬ ë¶€ì±„ ìš°ì„  ìƒí™˜)"
  ]
}}

### í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ ì¶”ì²œ ë¡œì§ (ìš°ì„ ìˆœìœ„ ê²°ì • ê¸°ì¤€)
1. **Priority 1 (ìµœìš°ì„ )**: í¬íŠ¸í´ë¦¬ì˜¤ ê· í˜• íšŒë³µì— ê°€ì¥ ì‹œê¸‰í•œ ìƒí’ˆ
   - í˜„ê¸ˆ ê³¼ë‹¤({cash_ratio:.1f}% > 40%) â†’ ì ê¸ˆìœ¼ë¡œ ìì‚° íš¨ìœ¨í™”
   - ë¶€ì±„ ê³¼ë‹¤({debt_ratio:.1f}% > 30%) â†’ ê³ ê¸ˆë¦¬ ë‹¨ê¸° ì˜ˆê¸ˆìœ¼ë¡œ ìƒí™˜ ì¤€ë¹„
   - íˆ¬ì ê³¼ë‹¤({invest_ratio:.1f}% > 70%) â†’ ì˜ˆê¸ˆìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´

2. **Priority 2 (ì¶”ì²œ)**: ìˆ˜ìµë¥  ìµœì í™”ë¥¼ ìœ„í•œ ë³´ì¡° ìƒí’ˆ
   - ìµœê³  ê¸ˆë¦¬ ìƒí’ˆ ì¤‘ ê°€ì… ë°©ë²•ì´ í¸ë¦¬í•œ ê²ƒ

3. **Priority 3 (ê³ ë ¤)**: ì¥ê¸°ì  ì¬ë¬´ ëª©í‘œë¥¼ ìœ„í•œ ì¶”ê°€ ìƒí’ˆ
   - ì¥ê¸° ì ê¸ˆ, ëª©ëˆ ë§ˆë ¨ìš© ì˜ˆê¸ˆ ë“±

### ì¶”ì²œ ì œì•½ ì¡°ê±´
- ìµœëŒ€ 3ê°œ ìƒí’ˆë§Œ ì¶”ì²œ (ìš°ì„ ìˆœìœ„ 1, 2, 3)
- ê° ìƒí’ˆì˜ ì¶”ì²œ ì´ìœ ëŠ” ë°˜ë“œì‹œ ìœ„ 4ê°€ì§€ í•µì‹¬ ì§€í‘œì™€ ì—°ê²°í•˜ì—¬ ì„¤ëª…
- ë¹„ëŒ€ë©´ ê°€ì… ê°€ëŠ¥ ìƒí’ˆ ìš°ì„  ê³ ë ¤

### ì¶”ì²œ ë¶ˆê°€ ì‹œ
ë§Œì•½ ì ì ˆí•œ ìƒí’ˆì´ ì—†ê±°ë‚˜ ì¶”ì²œì´ ì–´ë ¤ìš´ ê²½ìš°:
- recommended_productsëŠ” ë¹ˆ ë°°ì—´ []
- investment_strategyì— "í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœì—ì„œëŠ” ì¶”ê°€ ê¸ˆìœµìƒí’ˆ ê°€ì…ë³´ë‹¤ [ë¶€ì±„ ìƒí™˜/ì§€ì¶œ ê´€ë¦¬/ë¹„ìƒê¸ˆ í™•ë³´ ë“± êµ¬ì²´ì  ëŒ€ì•ˆ ì œì‹œ]ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ ì‘ì„±
"""

        # ===== STEP 7: GPT-4o API í˜¸ì¶œ ë° AI ì¶”ë¡  ì‹¤í–‰ =====
        # OpenAI GPT-4o ëª¨ë¸ì— êµ¬ì¡°í™”ëœ í”„ë¡¬í”„íŠ¸ ì „ì†¡
        # ëª¨ë¸ íŒŒë¼ë¯¸í„° ì„¤ì •:
        # - model="gpt-4o": ìµœì‹  ë©€í‹°ëª¨ë‹¬ LLM, ë³µì¡í•œ ë¶„ì„ ëŠ¥ë ¥ ë³´ìœ 
        # - response_format="json_object": JSON ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜ ê°•ì œ (íŒŒì‹± ì•ˆì •ì„± í™•ë³´)
        # - temperature=0.7: ì°½ì˜ì„±ê³¼ ì¼ê´€ì„±ì˜ ê· í˜• (0.0=ê²°ì •ì , 1.0=ì°½ì˜ì )

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",  # System message: AIì˜ ì—­í• ê³¼ í–‰ë™ ê·œì¹™ ì •ì˜
                    "content": "ë‹¹ì‹ ì€ ê³ ê°ì˜ ì¬ì • ìƒíƒœë¥¼ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ê¸ˆìœµ ìƒí’ˆì„ ì¶”ì²œí•˜ëŠ” AI ê¸ˆìœµ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. í•­ìƒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤."
                },
                {
                    "role": "user",  # User message: ì‹¤ì œ ìš”ì²­ ë‚´ìš© (í”„ë¡¬í”„íŠ¸)
                    "content": prompt_content
                }
            ],
            response_format={"type": "json_object"},  # JSON ëª¨ë“œ í™œì„±í™”
            temperature=0.7  # ì¶”ì²œì˜ ë‹¤ì–‘ì„±ê³¼ ì¼ê´€ì„± ê· í˜•
        )

        # ===== STEP 8: AI ì‘ë‹µ íŒŒì‹± ë° ê²€ì¦ =====
        # GPTê°€ ë°˜í™˜í•œ JSON ë¬¸ìì—´ì„ Python ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
        import json
        result = json.loads(response.choices[0].message.content)

        # ê²°ê³¼ êµ¬ì¡°:
        # {
        #   "portfolio_analysis": {
        #     "cash_ratio_assessment": "...",      # í˜„ê¸ˆ ë¹„ìœ¨ ë¶„ì„
        #     "investment_ratio_assessment": "...", # íˆ¬ì ë¹„ìœ¨ ë¶„ì„
        #     "debt_assessment": "...",             # ë¶€ì±„ í‰ê°€
        #     "liquidity_assessment": "..."         # ìœ ë™ì„± í‰ê°€
        #   },
        #   "recommended_products": [               # ì¶”ì²œ ìƒí’ˆ ëª©ë¡ (ìµœëŒ€ 3ê°œ)
        #     {
        #       "product_code": "...",               # ìƒí’ˆ ì½”ë“œ (DB ì¡°íšŒìš©)
        #       "product_type": "deposit/saving",    # ì˜ˆê¸ˆ/ì ê¸ˆ êµ¬ë¶„
        #       "bank_name": "...",
        #       "product_name": "...",
        #       "max_rate": 3.5,                     # ìµœê³  ê¸ˆë¦¬
        #       "reason": "...",                     # ì¶”ì²œ ì´ìœ  (í¬íŠ¸í´ë¦¬ì˜¤ ê´€ì )
        #       "priority": 1                        # ìš°ì„ ìˆœìœ„ (1=ìµœìš°ì„ , 2=ì¶”ì²œ, 3=ê³ ë ¤)
        #     }
        #   ],
        #   "investment_strategy": "...",            # ì¢…í•© íˆ¬ì ì „ëµ
        #   "action_items": ["...", "...", "..."]    # ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì  ì¡°ì–¸
        # }

        # ===== STEP 9: í”„ë¡ íŠ¸ì—”ë“œë¡œ ê²°ê³¼ ë°˜í™˜ =====
        return Response({
            'success': True,
            'data': result  # Vueì—ì„œ aiRecommendations.valueë¡œ ì €ì¥ë¨
        })

    except Exception as e:
        # ì˜ˆì™¸ ì²˜ë¦¬: API ì˜¤ë¥˜, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, JSON íŒŒì‹± ì˜¤ë¥˜ ë“±
        return Response({
            'success': False,
            'error': f'ìƒí’ˆ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'
        }, status=500)


def format_products_for_prompt(products):
    """
    ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ GPT í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ë¡œ í¬ë§·íŒ…
    """
    if not products:
        return "ì‚¬ìš© ê°€ëŠ¥í•œ ìƒí’ˆ ì—†ìŒ"

    text = ""
    for idx, prod in enumerate(products, 1):
        text += f"{idx}. [{prod['bank']}] {prod['name']} - ìµœê³ ê¸ˆë¦¬: {prod['max_rate']}%\n"
        text += f"   ìƒí’ˆì½”ë“œ: {prod['code']}, ê°€ì…ë°©ë²•: {prod['join_way']}\n"

    return text


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def luck(request):
    """
    ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ìš´ì„¸ ìƒì„± (ìƒë…„ì›”ì¼ ê¸°ë°˜)
    """
    try:
        user = request.user
        
        # ìƒë…„ì›”ì¼ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°˜í™˜
        if not user.birth_date:
            return Response({
                'success': False,
                'error': 'birth_date_required',
                'message': 'ìƒë…„ì›”ì¼ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. í”„ë¡œí•„ ì„¤ì •ì—ì„œ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
            }, status=400)
        
        # ìƒë…„ì›”ì¼ ì •ë³´ ì¤€ë¹„
        from datetime import datetime
        today = datetime.now()
        age = today.year - user.birth_date.year
        birth_year = user.birth_date.year
        birth_month = user.birth_date.month
        birth_day = user.birth_date.day
        
        birth_info = f"""
        - ìƒë…„ì›”ì¼: {birth_year}ë…„ {birth_month}ì›” {birth_day}ì¼
        - ë‚˜ì´: ë§Œ {age}ì„¸
        """
        
        # í”„ë¡¬í”„íŠ¸ ì‘ì„±
        prompt_content = f"""
        ì‚¬ìš©ìì˜ ìƒë…„ì›”ì¼({user.birth_date})ì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ì£¼ëª…ë¦¬í•™(ë§Œì„¸ë ¥) ê¸ˆì „ìš´ì„ ë¶„ì„í•˜ì„¸ìš”.

        ## ì§€ì¹¨
        1. 'í–‰ìš´ì˜ ê°€ì´ë“œ'ë¥¼ ì œì™¸í•œ ëª¨ë“  ì„¹ì…˜ì˜ 'content'ëŠ” ë°˜ë“œì‹œ **5ë¬¸ì¥ ì´ìƒì˜ ìƒì„¸í•œ ì„¤ëª…**ì„ í¬í•¨í•˜ì„¸ìš”.
        2. 'í–‰ìš´ì˜ ê°€ì´ë“œ'ëŠ” "ìƒ‰ìƒ: ê·¸ë¦°, ì•„ì´í…œ: ì†ëª©ì‹œê³„, ì¥ì†Œ: ê³µì›" ì²˜ëŸ¼ ì§§ì€ í‚¤ì›Œë“œë¡œë§Œ 3~4ê°œ ì‘ì„±í•˜ì„¸ìš”.
        3. luck_indexëŠ” ë°˜ë“œì‹œ 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.

        í˜•ì‹:
        {{
            "luck_index": 65,
            "summary": "ì•ˆì •ì ì¸ íë¦„ ì†ì— ì‘ì€ ê¸°íšŒê°€ ì°¾ì•„ì˜¤ëŠ” ë‚ ì…ë‹ˆë‹¤.",
            "details": [
                {{ "title": "ğŸ® ë§Œì„¸ë ¥ ê¸°ë°˜ ì‚¬ì£¼ í’€ì´", "content": "..." }},
                {{ "title": "ğŸ’° ê¸ˆì „ìš´ ìƒì„¸ ë¶„ì„", "content": "..." }},
                {{ "title": "ğŸ¨ í–‰ìš´ì˜ ê°€ì´ë“œ (ìƒ‰ìƒ/ë¬¼ê±´)", "content": "..." }},
                {{ "title": "ğŸš¶ ì˜¤ëŠ˜ì˜ í–‰ë™ ì§€ì¹¨", "content": "..." }}
            ]
        }}
        """

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ë§Œì„¸ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸ˆì „ìš´ì„ ë¶„ì„í•˜ì—¬ ë°˜ë“œì‹œ JSON ê°ì²´ë¡œë§Œ ì‘ë‹µí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤."},
                {"role": "user", "content": prompt_content}
            ],
            response_format={ "type": "json_object" },
            temperature=0.8
        )

        import json
        result_data = json.loads(response.choices[0].message.content)
        return Response({'success': True, **result_data})

    except Exception as e:
        return Response({
            'success': False,
            'error': 'api_error',
            'message': f'ìš´ì„¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'
        }, status=500)